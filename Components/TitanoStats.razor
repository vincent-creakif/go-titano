@inject IJSRuntime JsRuntime
@inject TitanoService TitanoService

<div class="stats stats-vertical overflow-hidden">
    <div class="titano">
        <svg width="64px" viewBox="0 0 64 45" fill="white" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true">
            <path d="M22.7734 16.3522C21.8844 15.0987 20.5971 14.0266 18.5667 13.3545C19.5245 15.5218 18.4896 17.1043 16.9268 19.4907C16.3893 20.3109 15.7781 21.2444 15.1877 22.3413L19.7509 30.2098L24.7085 20.6529C24.2229 19.1549 23.681 17.6293 22.7745 16.3522H22.7734ZM25.9074 17.431C28.9805 10.5343 34.3375 10.478 40.6185 10.4121C41.6393 10.4014 42.6871 10.3907 43.7823 10.3428L48.2943 2.37514L3.80213 2.24556L8.19636 10.1974C8.75466 10.2177 9.28703 10.2335 9.81603 10.2493C12.7692 10.3371 15.6451 10.4228 18.6282 11.038L18.7115 11.0554C21.5779 11.8712 23.3683 13.328 24.6004 15.0654C25.1171 15.8064 25.5552 16.5992 25.9074 17.431ZM35.1465 19.6084C33.5759 17.0383 32.4857 15.2536 33.1376 13.4632C30.5168 14.3736 28.42 16.3364 27.1237 20.618L32.2734 29.825L36.7803 22.4032C36.2169 21.3588 35.6502 20.4349 35.1465 19.6084ZM33.2153 32.5894L27.0746 43.5643L26.1293 45.2544L25.1344 43.5953L19.8794 34.8338L19.863 34.8654L18.8383 33.0987L12.9399 22.9311L12.6357 22.4066L12.9089 21.8658C13.652 20.3966 14.4024 19.2507 15.0497 18.2637C16.4468 16.1296 17.2502 14.9032 15.5567 12.8165C13.6373 12.5996 11.7146 12.5421 9.75406 12.4841C8.98113 12.461 8.20369 12.4379 7.47526 12.4081L6.84147 12.3816L6.53614 11.8295L0.918284 1.66192L0 0L1.90135 0.00506834L50.212 0.145349L52.1274 0.150981L51.1849 1.81515L45.4273 11.9822L45.1265 12.514L44.5147 12.5478C43.2189 12.6199 41.9086 12.6334 40.6359 12.6469C39.1926 12.6616 37.8056 12.6762 36.4975 12.7951C34.5939 14.4091 35.4834 15.8688 37.0608 18.4422C37.6721 19.4428 38.3673 20.5796 39.0619 21.9272L39.3481 22.4816L39.0224 23.0184L33.2153 32.5894ZM21.0912 32.4987L26.0589 40.7869L30.9523 32.0452L25.9541 23.1153L21.0912 32.4987Z" fill="#fff"></path>
        </svg>
    </div>

    <div class="stat first">
        <div class="stat-title opacity-80">Your balance</div>
        <Display If="Balances is null">
            <span class="btn btn-ghost loading btn-md btn-circle"></span>
        </Display>
        <Display If="Balances is not null">
            <div class="stat-value">
                <div class="dropdown dropdown-hover initial-balance">
                    <label tabindex="0">
                        <span class="text-accent">@_currencySymbol</span><DisplayDecimal Value="Balances.BalanceAmountValue" />
                    </label>
                    <ul tabindex="0" class="mt-1 p-2 dropdown-content bg-base-300 w-auto font-normal text-xs">
                        <Display If="InitialBalance is null">
                            <span class="btn btn-ghost loading btn-sm btn-circle"></span>
                        </Display>
                        <Display If="InitialBalance is not null">
                            <li>
                                <strong>First deposit stats</strong>
                                <span class="divider m-0"></span>
                            </li>
                            <li>
                                <em>Amount:</em>
                                <DisplayDecimal Value="InitialBalance.Value" Unit="TITANO" />
                            </li>
                            <li>
                                <em>Date:</em>
                                <DisplayDate Value="InitialBalance.CreatedAt" StringFormat="yyyy-MM-dd" />
                                <small class="opacity-40">
                                    (<DisplayHumanizedDate Value="InitialBalance.CreatedAt" />)
                                </small>
                            </li>
                            <li>
                                <em>Increased value:</em>
                                <span class="text-accent">@_currencySymbol</span><DisplayDecimal Value="BalanceAmountValueIncrease(InitialBalance.Value, Balances.BalanceAmount)" />
                            </li>
                            <li>
                                <em>Increased amount:</em>
                                <DisplayDecimal Value="BalanceAmountIncrease(InitialBalance.Value, Balances.BalanceAmount)" Unit="TITANO" />
                            </li>
                        </Display>
                    </ul>
                </div>
            </div>
            <div class="stat-desc pt-1 font-mono">
                <DisplayDecimal Value="Balances.BalanceAmount" Unit="TITANO" />
            </div>
        </Display>
    </div>

    <div class="stat">
        <div class="stat-title opacity-80">TITANO price</div>
        <Display If="Price is null">
            <span class="btn btn-ghost loading btn-md btn-circle"></span>
        </Display>
        <Display If="Price is not null">
            <div class="stat-value">
                <span class="text-accent">@_currencySymbol</span><DisplayDecimal Value="Price.In(Currency)" StringFormat="N4" />
            </div>
            <div class="stat-desc pt-1 font-mono">
                <DisplayDate Value="Price.LastUpdatedAtLocalTime" />
            </div>
        </Display>
    </div>

    <div class="stat">
        <div class="stat-title opacity-80">Rebase earnings</div>
        <Display If="Earnings is null">
            <span class="btn btn-ghost loading btn-md btn-circle"></span>
        </Display>
        <Display If="Earnings is not null">
            <div class="stat-value">
                <span class="text-accent">@_currencySymbol</span><DisplayDecimal Value="Earnings.RebaseAmountValue" />
            </div>
            <div class="stat-desc pt-1 font-mono">
                <DisplayDecimal Value="Earnings.RebaseAmount" Unit="TITANO" />
                <br />
                rebase in
                <Display If="_rebaseCountdownMinutes is not null && _rebaseCountdownSeconds is not null">
                    <span class="countdown">
                        <span class="pr-1" style="--value:@_rebaseCountdownMinutes"></span>m
                        <span class="px-1" style="--value:@_rebaseCountdownSeconds"></span>s
                    </span>
                </Display>
            </div>
        </Display>
    </div>

    <div class="stat">
        <div class="stat-title opacity-80">Daily earnings</div>
        <Display If="Earnings is null">
            <span class="btn btn-ghost loading btn-md btn-circle"></span>
        </Display>
        <Display If="Earnings is not null">
            <div class="stat-value">
                <span class="text-accent">@_currencySymbol</span><DisplayDecimal Value="Earnings.DailyRebaseAmountValue" />
            </div>
            <div class="stat-desc pt-1 font-mono">
                <DisplayDecimal Value="Earnings.DailyRebaseAmount" Unit="TITANO" />
            </div>
        </Display>
    </div>
    
    <div class="stat">
        <div class="stat-title opacity-80">Holders</div>
        <Display If="Holders is null">
            <span class="btn btn-ghost loading btn-md btn-circle"></span>
        </Display>
        <Display If="Holders is not null">
            <div class="stat-figure text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            </div>            
            <div class="stat-value text-primary">
                <DisplayDecimal Value="Holders.TotalCount" StringFormat="N0"/>
            </div>
            <div class="stat-desc pt-1 font-mono">
                <DisplayDate Value="Holders.LastUpdatedAtLocalTime"/>
            </div>
        </Display>
    </div>
</div>

@code {
    [Parameter]
    public CoinGeckoSimplePriceItemModel Price { get; set; }
    [Parameter]
    public BscScanResultItemModel InitialBalance { get; set; }
    [Parameter]
    public TitanoBalancesModel Balances { get; set; }
    [Parameter]
    public TitanoEarningsModel Earnings { get; set; }
    [Parameter]
    public BscScanHoldersModel Holders { get; set; }    
    [Parameter]
    public string Currency { get; set; }

    private string _currencySymbol;
    
    private int? _rebaseCountdownMinutes;
    private int? _rebaseCountdownSeconds;
    
    protected override void OnParametersSet()
    {
        _currencySymbol = Currencies.Symbols[Currency];
    }    

    [JSInvokable]
    public async Task SetRebaseCountdownAsync()
    {
        var rebaseTime = TitanoService.RebaseTime;

        _rebaseCountdownMinutes = (60 - rebaseTime.Minute) % 30;
        _rebaseCountdownSeconds = 60 - rebaseTime.Second;

        if (_rebaseCountdownSeconds == 60)
        {
            _rebaseCountdownSeconds--;
        }

        StateHasChanged();
    }

    private decimal BalanceAmountIncrease(decimal initialBalance, decimal balanceAmount)
    {
        return balanceAmount - initialBalance;
    }

    private decimal BalanceAmountValueIncrease(decimal initialBalance, decimal balanceAmount)
    {
        return BalanceAmountIncrease(initialBalance, balanceAmount) * Price.In(Currency);
    }
}
